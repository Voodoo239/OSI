#!/bin/bash

field=($(printf '0 %.0s' {1..20}))
enemy_hits=0
my_hits=0
enemy_ships=9

place_ships() {
    pos=$((RANDOM % 20))
    field[$pos]=1
    while true; do
        pos=$((RANDOM % 19))
        if [ ${field[$pos]} -eq 0 ] && [ ${field[$((pos+1))]} -eq 0 ]; then
            field[$pos]=1
            field[$((pos+1))]=1
            break
        fi
    done
    while true; do
        pos=$((RANDOM % 18))
        if [ ${field[$pos]} -eq 0 ] && [ ${field[$((pos+1))]} -eq 0 ] && [ ${field[$((pos+2))]} -eq 0 ]; then
            field[$pos]=1
            field[$((pos+1))]=1
            field[$((pos+2))]=1
            break
        fi
    done
    while true; do
        pos=$((RANDOM % 18))
        if [ ${field[$pos]} -eq 0 ] && [ ${field[$((pos+1))]} -eq 0 ] && [ ${field[$((pos+2))]} -eq 0 ]; then
            field[$pos]=1
            field[$((pos+1))]=1
            field[$((pos+2))]=1
            break
        fi
    done
}

shoot() {
    if [ -z "${checked[*]}" ]; then
        checked=($(printf '0 %.0s' {1..20}))
    fi
    if [ $enemy_ships -ge 3 ]; then
        for i in {0..19}; do
            if [ ${checked[$i]} -eq 1 ] && [ ${field[$i]} -eq 2 ]; then
                if [ $i -gt 0 ] && [ ${checked[$((i-1))]} -eq 0 ]; then
                    checked[$((i-1))]=1
                    echo $((i-1))
                    return
                fi
                if [ $i -lt 19 ] && [ ${checked[$((i+1))]} -eq 0 ]; then
                    checked[$((i+1))]=1
                    echo $((i+1))
                    return
                fi
            fi
        done
    fi
    while true; do
        pos=$((RANDOM % 20))
        if [ ${checked[$pos]} -eq 0 ]; then
            checked[$pos]=1
            echo $pos
            return
        fi
    done
}

place_ships

echo "Player 2: My PID is $$"
while true; do
    read enemy_shot < pipe1
    echo "Player 1 shoots at $enemy_shot"
    if [ ${field[$enemy_shot]} -eq 1 ]; then
        echo "hit" > pipe2
        field[$enemy_shot]=2
        my_hits=$((my_hits + 1))
        echo "Player 2: Hit on my field at $enemy_shot"
    else
        echo "miss" > pipe2
        field[$enemy_shot]=3
        echo "Player 2: Miss on my field at $enemy_shot"
    fi

    if [ $my_hits -eq 9 ]; then
        echo "Player 1 wins!"
        break
    fi

    shot=$(shoot)
    echo "Player 2 shoots at $shot"
    echo "$shot" > pipe1

    read result < pipe2
    if [ "$result" = "hit" ]; then
        enemy_hits=$((enemy_hits + 1))
        enemy_ships=$((enemy_ships - 1))
        echo "Player 2: Hit! Enemy ships left: $enemy_ships"
        field[$shot]=2
    else
        echo "Player 2: Miss"
        field[$shot]=3
    fi

    if [ $enemy_hits -eq 9 ]; then
        echo "Player 2 wins!"
        break
    fi
done
