#!/bin/bash

# генерация поля
field=(0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0)

# размещение однопалубного корабля
curnum=$RANDOM
let "curnum=$curnum%20"
field[$curnum]=1

# размещение двухпалубного корабля
curnum=$RANDOM
let "curnum=$curnum%20"
while [[ ($curnum -ge 19 || ${field[$curnum]} -ne 0 || ${field[$curnum+1]} -ne 0) ]]
do
    let "curnum=$curnum+1"
    let "curnum=$curnum%20"
done
field[$curnum]=2
field[$curnum+1]=2

# размещение трехпалубного корабля (первого)
curnum=$RANDOM
let "curnum=$curnum%20"
while [[ ($curnum -ge 18 || ${field[$curnum]} -ne 0 || ${field[$curnum+1]} -ne 0 || ${field[$curnum+2]} -ne 0) ]]
do
    let "curnum=$curnum+1"
    let "curnum=$curnum%20"
done
field[$curnum]=3
field[$curnum+1]=3
field[$curnum+2]=3

# размещение трехпалубного корабля (второго)
curnum=$RANDOM
let "curnum=$curnum%20"
while [[ ($curnum -ge 18 || ${field[$curnum]} -ne 0 || ${field[$curnum+1]} -ne 0 || ${field[$curnum+2]} -ne 0) ]]
do
    let "curnum=$curnum+1"
    let "curnum=$curnum%20"
done
field[$curnum]=4
field[$curnum+1]=4
field[$curnum+2]=4

# начинаем стрелять
opponent=(0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0)
myships=4
oppships=4


(tail -f pipe1) | while true; do
    read line

    if [[ $line =~ ^[0-9]+$ ]]; then
        if [[ ${field[$line]} -eq 0 ]]; then
            echo "mis" > pipe2
            echo "mis > pipe2"
        else
            if [[ ($line -le 18 && ${field[$line+1]} -eq ${field[$line]}) ||
                 ($line -ge 1 && ${field[$line-1]} -eq ${field[$line]}) ||
                 ($line -le 17 && ${field[$line+2]} -eq ${field[$line]}) ||
                 ($line -ge 2 && ${field[$line-2]} -eq ${field[$line]}) ]]; then
                field[$line]=0
                echo "wound" > pipe2
                echo "wound > pipe2"
            else
                field[$line]=0
                echo "kill" > pipe2
                echo "kill > pipe2"
                let "myships=$myships-1"

                if [[ $myships -eq 0 ]]; then
                    echo "exit" > pipe1
                    echo "exit > pipe1"
                fi
            fi
        fi
    fi

    case $line in
        "kill")
            # минус мертвый корабль и ready to shot
            let "oppships=$oppships-1"
            if [[ $oppships -eq 0 ]]; then
                echo "exit" > pipe1
                echo "exit > pipe1"
            else
                echo "ready to shot" > pipe1
                echo "ready to shot > pipe1"
            fi
            ;;

        "wound")
            # можно стрелять
            echo "ready to shot" > pipe1
            echo "ready to shot > pipe1"
            ;;

        "mis")
            # говорим что второму можно стрелять
            echo "ready to shot" > pipe2
            echo "ready to shot > pipe2"
            ;;

        "ready to shot")
            # стреляем
            shot=$RANDOM
            let "shot=$shot%20"
            while [[ ${opponent[$shot]} -ne 0 ]]; do
                let "shot=$shot+1"
                let "shot=$shot%20"
            done
            opponent[$shot]=1
            echo $shot > pipe2
            echo "$shot > pipe2"
            ;;

        "exit")
            if [[ $oppships -eq 0 ]]; then
                echo win
            else
                echo lose
            fi

            echo "
            ${field[0]} ${field[1]} ${field[2]} ${field[3]} ${field[4]}
            ${field[5]} ${field[6]} ${field[7]} ${field[8]} ${field[9]}
            ${field[10]} ${field[11]} ${field[12]} ${field[13]} ${field[14]}
            ${field[15]} ${field[16]} ${field[17]} ${field[18]} ${field[19]}"

            rm -rf pipe2
            rm -rf pipe1
            killall tail
            exit
            ;;
    esac
done
